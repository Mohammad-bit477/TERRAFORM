name: Deploy Script to EC2 via SSM

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      REGION: ap-south-1
      INSTANCE_ID: i-055aaab9a654f2e4c  
      LOG_GROUP: /github-actions/deploy-logs

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::<AWS_ACCOUNT_ID>:role/github-oidc-deploy-role
        aws-region: ${{ env.REGION }}

    - name: Run deploy script on EC2 via SSM
      run: |
        echo "Sending inline deploy script via SSM..."

        SCRIPT_COMMANDS=$(cat <<'EOT'
        FILE="/home/ec2-user/project"
        if [ ! -f "$FILE" ]; then
          echo "the is my 1st deployment" > "$FILE"
        fi
        chmod +x "$FILE"

        while true; do
          echo "the is my 1st deployment"
          sleep 180
        done
        EOT
        )

        aws ssm send-command \
          --targets "Key=instanceIds,Values=${INSTANCE_ID}" \
          --document-name "AWS-RunShellScript" \
          --comment "Deploy project script inline" \
          --parameters "commands=[\"$SCRIPT_COMMANDS\"]" \
          --cloud-watch-output-config "{\"CloudWatchOutputEnabled\":true,\"CloudWatchLogGroupName\":\"${LOG_GROUP}\"}" \
          --region $REGION

