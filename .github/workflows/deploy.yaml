name: Deploy Script to EC2 (Private)

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      INSTANCE_ID: i-055aaab9a654f2e4c
      LOG_GROUP: /github-actions/deploy-logs
      REGION: ap-south-1

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::538605215529:role/github
        aws-region: ${{ env.REGION }}

    - name: Run deploy script on EC2 via SSM
      run: |
        echo "Sending SSM command with inline script..."
        
        # Prepare multi-line script commands
        SCRIPT_COMMANDS=$(cat <<'EOF'
mkdir -p /tmp/deploy_scripts
echo "#!/bin/bash" > /tmp/deploy_scripts/deploy.sh
echo "echo Hello from deploy script" >> /tmp/deploy_scripts/deploy.sh
echo "echo Running additional deployment steps..." >> /tmp/deploy_scripts/deploy.sh
chmod +x /tmp/deploy_scripts/deploy.sh
/tmp/deploy_scripts/deploy.sh
EOF
        )

        # Send command via SSM
        aws ssm send-command \
          --targets "Key=instanceIds,Values=${INSTANCE_ID}" \
          --document-name "AWS-RunShellScript" \
          --comment "Deploy project script inline" \
          --parameters "commands=[\"$SCRIPT_COMMANDS\"]" \
          --cloud-watch-output-config "{\"CloudWatchOutputEnabled\":true,\"CloudWatchLogGroupName\":\"${LOG_GROUP}\"}" \
          --region $REGION
